<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#007AFF">
    <title>Simple Transcription Widget</title>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);
        
          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;
        
          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
          --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
          --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
          --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
          --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
          --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
          --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
          --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */
        
          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
        
          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        
          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;
        
          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;
        
          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;
        
          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;
        
          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);
        
          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        
          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        }
        
        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
          :root {
            /* RGB versions for opacity control (Dark Mode) */
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;
        
            /* Background color tokens (Dark Mode) */
            --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
            --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
            --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
            --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
            --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
            --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
            --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
            --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */
        
            /* Semantic Color Tokens (Dark Mode) */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
              inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
        
            /* Common style patterns - updated for dark mode */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;
            --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        
            /* RGB versions for dark mode */
            --color-success-rgb: var(--color-teal-300-rgb);
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }
        
        /* Base styles */
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }
        
        body {
          margin: 0;
          padding: 0;
        }
        
        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }
        
        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          color: var(--color-text);
          letter-spacing: var(--letter-spacing-tight);
        }
        
        h1 {
          font-size: var(--font-size-4xl);
        }
        h2 {
          font-size: var(--font-size-3xl);
        }
        h3 {
          font-size: var(--font-size-2xl);
        }
        h4 {
          font-size: var(--font-size-xl);
        }
        h5 {
          font-size: var(--font-size-lg);
        }
        h6 {
          font-size: var(--font-size-md);
        }
        
        p {
          margin: 0 0 var(--space-16) 0;
        }
        
        a {
          color: var(--color-primary);
          text-decoration: none;
          transition: color var(--duration-fast) var(--ease-standard);
        }
        
        a:hover {
          color: var(--color-primary-hover);
        }

        /* Buttons */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-16);
          border-radius: var(--radius-base);
          font-size: var(--font-size-base);
          font-weight: 500;
          line-height: 1.5;
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
          position: relative;
        }
        
        .btn:focus-visible {
          outline: none;
          box-shadow: var(--focus-ring);
        }
        
        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }
        
        .btn--primary:hover {
          background: var(--color-primary-hover);
        }
        
        .btn--primary:active {
          background: var(--color-primary-active);
        }
        
        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }
        
        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }
        
        .btn--secondary:active {
          background: var(--color-secondary-active);
        }
        
        .btn--outline {
          background: transparent;
          border: 1px solid var(--color-border);
          color: var(--color-text);
        }
        
        .btn--outline:hover {
          background: var(--color-secondary);
        }
        
        .btn--sm {
          padding: var(--space-4) var(--space-12);
          font-size: var(--font-size-sm);
          border-radius: var(--radius-sm);
        }
        
        .btn--lg {
          padding: var(--space-10) var(--space-20);
          font-size: var(--font-size-lg);
          border-radius: var(--radius-md);
        }
        
        .btn--full-width {
          width: 100%;
        }
        
        .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        
        /* Form elements */
        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-md);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast) var(--ease-standard),
            box-shadow var(--duration-fast) var(--ease-standard);
        }
        
        textarea.form-control {
          font-family: var(--font-family-base);
          font-size: var(--font-size-base);
        }
        
        select.form-control {
          padding: var(--space-8) var(--space-12);
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: var(--select-caret-light);
          background-repeat: no-repeat;
          background-position: right var(--space-12) center;
          background-size: 16px;
          padding-right: var(--space-32);
        }
        
        /* Add a dark mode specific caret */
        @media (prefers-color-scheme: dark) {
          select.form-control {
            background-image: var(--select-caret-dark);
          }
        }
        
        .form-control:focus {
          border-color: var(--color-primary);
          outline: var(--focus-outline);
        }
        
        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }
        
        .form-group {
          margin-bottom: var(--space-16);
        }
        
        /* Card component */
        .card {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
          transition: box-shadow var(--duration-normal) var(--ease-standard);
          margin-bottom: var(--space-20);
        }
        
        .card:hover {
          box-shadow: var(--shadow-md);
        }
        
        .card__body {
          padding: var(--space-20);
        }
        
        .card__header,
        .card__footer {
          padding: var(--space-20);
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        /* Simplified Widget Styles */
        
        /* Widget container */
        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-16);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .widget-title {
            font-size: 20px;
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }
        
        .widget-controls {
            display: flex;
            gap: var(--space-8);
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: var(--space-8);
            border-radius: var(--radius-base);
            transition: background var(--duration-fast) var(--ease-standard);
            color: var(--color-text);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            background: var(--color-secondary);
        }
        
        /* Widget body */
        .widget-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Record section */
        .record-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-32) var(--space-20);
            background: var(--color-background);
            border-bottom: 1px solid var(--color-border);
        }
        
        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-normal) var(--ease-standard);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--space-20);
        }
        
        .record-button.idle {
            background: var(--color-primary);
            color: white;
        }
        
        .record-button.recording {
            background: #FF3B30;
            color: white;
            animation: pulse-record 2s infinite;
        }
        
        .record-button.processing {
            background: #FF9500;
            color: white;
        }
        
        .record-button:hover:not(.recording) {
            transform: scale(1.05);
        }
        
        .record-button:active {
            transform: scale(0.95);
        }
        
        @keyframes pulse-record {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .record-icon {
            font-size: 36px;
            margin-bottom: var(--space-8);
        }
        
        .record-text {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            text-align: center;
            line-height: 1.2;
        }
        
        /* Recording info */
        .recording-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-12);
        }
        
        .timer {
            font-size: 32px;
            font-weight: var(--font-weight-bold);
            font-family: var(--font-family-mono);
            color: var(--color-text);
        }
        
        .status {
            font-size: 16px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }
        
        .audio-level {
            width: 200px;
            height: 6px;
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, #34C759, #FF9500, #FF3B30);
            border-radius: var(--radius-full);
            transition: width var(--duration-fast) var(--ease-standard);
            width: 0%;
        }
        
        /* Transcript section */
        .transcript-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .transcript-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-16);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
        }
        
        .transcript-title {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }
        
        .word-count {
            font-size: 14px;
            color: var(--color-text-secondary);
        }
        
        .transcript-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .transcript-content {
            flex: 1;
            padding: var(--space-20);
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-background);
            outline: none;
        }
        
        .transcript-content:focus {
            background: var(--color-surface);
        }
        
        .transcript-content .placeholder {
            color: var(--color-text-secondary);
            font-style: italic;
        }
        
        .transcript-content .interim {
            color: var(--color-text-secondary);
            opacity: 0.7;
        }
        
        .transcript-content .final {
            color: var(--color-text);
        }
        
        .transcript-content .low-confidence {
            background: rgba(var(--color-warning-rgb), 0.1);
            border-bottom: 1px dashed var(--color-warning);
        }
        
        /* Export panel */
        .export-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform var(--duration-normal) var(--ease-standard);
            box-shadow: var(--shadow-lg);
        }
        
        .export-panel.visible {
            transform: translateY(0);
        }
        
        .export-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }
        
        .export-title {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }
        
        .btn-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--color-text-secondary);
            padding: var(--space-4);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-base);
        }
        
        .btn-close:hover {
            background: var(--color-secondary);
            color: var(--color-text);
        }
        
        .export-buttons {
            display: flex;
            padding: var(--space-20);
            gap: var(--space-16);
            justify-content: center;
        }
        
        .export-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-16);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            min-width: 100px;
            min-height: 80px;
        }
        
        .export-btn:hover {
            background: var(--color-secondary);
            transform: translateY(-2px);
        }
        
        .export-btn .btn-icon {
            font-size: 24px;
            padding: 0;
            background: none;
            color: var(--color-primary);
        }
        
        .export-btn .btn-label {
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }
        
        /* Settings panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: var(--color-surface);
            border-left: 1px solid var(--color-border);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform var(--duration-normal) var(--ease-standard);
            box-shadow: var(--shadow-lg);
        }
        
        .settings-panel.visible {
            transform: translateX(0);
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }
        
        .settings-content {
            padding: var(--space-20);
        }
        
        .setting-group {
            margin-bottom: var(--space-20);
        }
        
        .setting-group label {
            display: block;
            font-size: 14px;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-8);
            color: var(--color-text);
        }
        
        .setting-group select {
            width: 100%;
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-background);
            color: var(--color-text);
            font-size: 14px;
        }
        
        .setting-group input[type="checkbox"] {
            margin-right: var(--space-8);
        }
        
        .settings-toggle {
            position: fixed;
            bottom: var(--space-20);
            right: var(--space-20);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow-lg);
            transition: all var(--duration-fast) var(--ease-standard);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Mobile responsive styles */
        @media (max-width: 767px) {
            .record-button {
                width: 140px;
                height: 140px;
            }
            
            .record-icon {
                font-size: 42px;
            }
            
            .record-text {
                font-size: 16px;
            }
            
            .transcript-content {
                font-size: 16px;
                padding: var(--space-16);
            }
            
            .settings-panel {
                width: 100%;
                transform: translateX(100%);
            }
            
            .export-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                gap: var(--space-12);
            }
            
            .export-btn {
                flex: 1;
                min-width: 80px;
            }
        }
        
        /* Web component styles */
        transcribe-widget {
            display: block;
            width: 100%;
            height: 100%;
            font-family: var(--font-family-base);
        }
        .app-container {
          display: flex;
          flex-direction: column;
          height: 100vh;
          background: var(--color-background);
          overflow: hidden;
        }













        /* Hero Recording Section */
        .hero-section {
          text-align: center;
          padding: var(--space-32) var(--space-20);
          background: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-3));
          border-radius: var(--radius-lg);
          margin-bottom: var(--space-32);
          border: 1px solid var(--color-border);
        }

        .hero-title {
          font-size: 28px;
          font-weight: var(--font-weight-bold);
          margin-bottom: var(--space-20);
          color: var(--color-text);
          line-height: 1.3;
        }

        .hero-subtitle {
          font-size: 18px;
          color: var(--color-text-secondary);
          margin-bottom: var(--space-32);
          line-height: 1.5;
          max-width: 300px;
          margin-left: auto;
          margin-right: auto;
        }

        /* Mobile Bottom Navigation */
        .bottom-nav {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: var(--color-surface);
          border-top: 1px solid var(--color-border);
          display: flex;
          z-index: 1000;
          padding: var(--space-12) 0;
          min-height: 70px;
          box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-4);
          text-decoration: none;
          color: var(--color-text-secondary);
          font-size: 12px;
          font-weight: var(--font-weight-medium);
          transition: color var(--duration-fast) var(--ease-standard);
          cursor: pointer;
          min-height: 48px;
          min-width: 48px;
        }

        .nav-item.active {
          color: #007AFF;
        }

        .nav-item:hover {
          color: var(--color-text);
        }

        .nav-icon {
          font-size: 24px;
          margin-bottom: var(--space-6);
          line-height: 1;
        }

        /* Desktop Styles (hidden on mobile) */
        .sidebar-left,
        .sidebar-right,
        .tabs {
          display: none;
        }

        /* Desktop Layout */
        @media (min-width: 768px) {
          .app-container {
            flex-direction: row;
          }

          .sidebar-left {
            display: flex;
            width: 300px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            flex-direction: column;
            overflow-y: auto;
          }

          .sidebar-right {
            display: flex;
            width: 280px;
            background: var(--color-surface);
            border-left: 1px solid var(--color-border);
            flex-direction: column;
            overflow-y: auto;
          }

          .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-surface);
          }

          .tab {
            padding: var(--space-12) var(--space-20);
            background: none;
            border: none;
            cursor: pointer;
            font-size: var(--font-size-md);
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: all var(--duration-fast) var(--ease-standard);
          }

          .tab:hover {
            color: var(--color-text);
            background: var(--color-secondary);
          }

          .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            background: var(--color-background);
          }

          .content-page {
            display: none;
            padding: var(--space-24);
            padding-bottom: var(--space-24);
          }

          .content-page.active {
            display: block;
          }

          .bottom-nav {
            display: none;
          }

          .hero-section {
            display: none;
          }
        }

        .sidebar-section {
          padding: var(--space-16);
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        .sidebar-section h3 {
          margin-bottom: var(--space-12);
          font-size: var(--font-size-lg);
          color: var(--color-text);
        }

        /* Hero Recording Button */
        .hero-record-btn {
          width: 200px;
          height: 120px;
          border-radius: var(--radius-lg);
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all var(--duration-normal) var(--ease-standard);
          font-size: 20px;
          font-weight: var(--font-weight-bold);
          margin: 0 auto var(--space-24);
          box-shadow: var(--shadow-lg);
          position: relative;
          overflow: hidden;
        }

        .hero-record-btn.start {
          background: #007AFF;
          color: white;
        }

        .hero-record-btn.recording {
          background: #FF3B30;
          color: white;
          animation: pulse-button 2s infinite;
        }

        .hero-record-btn.paused {
          background: #FF9500;
          color: white;
        }

        .hero-record-btn:hover {
          transform: scale(1.02);
          box-shadow: var(--shadow-lg), 0 0 20px rgba(0, 122, 255, 0.3);
        }

        .hero-record-btn:active {
          transform: scale(0.98);
        }

        @keyframes pulse-button {
          0%, 100% { 
            transform: scale(1);
            box-shadow: var(--shadow-lg), 0 0 20px rgba(255, 59, 48, 0.4);
          }
          50% { 
            transform: scale(1.02);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 59, 48, 0.6);
          }
        }

        .btn-icon {
          margin-right: var(--space-8);
          font-size: 24px;
        }

        /* Recording Controls */
        .recording-controls {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: var(--space-20);
          padding: var(--space-24);
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          margin-bottom: var(--space-32);
          border: 1px solid var(--color-border);
        }

        .recording-status {
          text-align: center;
          margin-bottom: var(--space-16);
        }

        .control-buttons {
          display: flex;
          gap: var(--space-16);
          margin-top: var(--space-20);
          justify-content: center;
          flex-wrap: wrap;
        }

        .control-btn {
          min-width: 120px;
          min-height: 56px;
          border-radius: var(--radius-lg);
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all var(--duration-normal) var(--ease-standard);
          font-size: 16px;
          font-weight: var(--font-weight-medium);
          padding: var(--space-12) var(--space-20);
          white-space: nowrap;
        }

        .control-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .control-btn.secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .control-btn.secondary:hover:not(:disabled) {
          background: var(--color-secondary-hover);
        }

        /* Mobile Recording Controls */
        @media (max-width: 767px) {
          .hero-record-btn {
            width: 90%;
            max-width: 300px;
            height: 120px;
          }

          .control-buttons {
            width: 100%;
            justify-content: center;
          }

          .control-btn {
            flex: 1;
            max-width: 120px;
          }
        }

        .recording-info {
          text-align: center;
          width: 100%;
          margin: var(--space-16) 0;
        }

        .recording-timer {
          font-size: 32px;
          font-weight: var(--font-weight-bold);
          color: var(--color-text);
          margin-bottom: var(--space-12);
          font-family: var(--font-family-mono);
          line-height: 1.2;
        }

        .recording-status-text {
          font-size: 18px;
          color: var(--color-text-secondary);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: var(--space-10);
          margin-top: var(--space-8);
        }

        .recording-dot {
          width: 12px;
          height: 12px;
          background: #FF3B30;
          border-radius: 50%;
          animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
          0%, 100% { 
            opacity: 1;
            transform: scale(1);
          }
          50% { 
            opacity: 0.3;
            transform: scale(1.2);
          }
        }

        /* Quick Setup Form */
        .quick-setup {
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          padding: var(--space-24);
          margin-bottom: var(--space-32);
          border: 1px solid var(--color-border);
        }

        .quick-setup h3 {
          font-size: 20px;
          margin-bottom: var(--space-20);
          color: var(--color-text);
        }

        .quick-form-group {
          margin-bottom: var(--space-20);
        }

        .quick-form-group label {
          display: block;
          font-size: 16px;
          font-weight: var(--font-weight-medium);
          margin-bottom: var(--space-10);
          color: var(--color-text);
          line-height: 1.4;
        }

        .quick-form-group input,
        .quick-form-group select {
          width: 100%;
          padding: var(--space-12) var(--space-16);
          font-size: 16px;
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          background: var(--color-background);
          color: var(--color-text);
          min-height: 48px;
          line-height: 1.4;
          box-sizing: border-box;
        }

        .advanced-toggle {
          background: none;
          border: none;
          color: var(--color-primary);
          font-size: 16px;
          cursor: pointer;
          margin-top: var(--space-16);
          text-decoration: underline;
          min-height: 44px;
          padding: var(--space-8) 0;
        }

        .advanced-options {
          display: none;
          margin-top: var(--space-24);
          padding-top: var(--space-20);
          border-top: 1px solid var(--color-border);
        }

        .advanced-options.visible {
          display: block;
        }

        /* Mobile-specific improvements */
        @media (max-width: 767px) {
          /* Larger touch targets */
          .btn {
            min-height: 48px;
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            padding: var(--space-12) var(--space-20);
          }
          
          .form-control {
            min-height: 48px;
            font-size: 16px;
            padding: var(--space-12) var(--space-16);
            margin-bottom: var(--space-16);
          }
          
          /* Improved readability */
          body {
            font-size: 16px;
            line-height: 1.5;
            padding-bottom: 90px;
          }
          
          h1, h2, h3, h4, h5, h6 {
            line-height: 1.3;
            margin-bottom: var(--space-20);
          }
          
          /* Card improvements */
          .card {
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-24);
          }
          
          .card__body {
            padding: var(--space-24);
          }
          
          /* Transcript improvements */
          .transcript-editor {
            font-size: 16px;
            line-height: 1.6;
            padding: var(--space-20);
            margin-bottom: var(--space-20);
          }
          
          .transcript-entry {
            margin-bottom: var(--space-20);
            padding: var(--space-20);
            font-size: 16px;
          }
          
          .speaker-tag {
            font-size: 14px;
            padding: var(--space-8) var(--space-16);
            min-height: 36px;
            display: inline-flex;
            align-items: center;
          }
          
          .timestamp {
            font-size: 12px;
          }
          
          /* Speaker list improvements */
          .speaker-item {
            padding: var(--space-16);
            min-height: 60px;
            border-radius: var(--radius-base);
            margin-bottom: var(--space-12);
          }
          
          /* Improved spacing */
          .content-page {
            padding: var(--space-20) var(--space-16);
          }
          
          .hero-section {
            padding: var(--space-32) var(--space-20) var(--space-32);
            margin-bottom: var(--space-32);
          }
          
          /* Status messages */
          .status {
            font-size: 14px;
            padding: var(--space-8) var(--space-12);
          }
          
          /* Better contrast for mobile */
          .hero-section {
            background: linear-gradient(135deg, 
              rgba(0, 122, 255, 0.1), 
              rgba(52, 199, 89, 0.1));
            border: 1px solid var(--color-border);
          }
          
          /* Ensure no overlap on very small screens */
          @media (max-height: 600px) {
            .hero-section {
              padding: var(--space-20) var(--space-16);
            }
            
            .content-page {
              padding: var(--space-12) var(--space-16);
            }
          }
        }
        
        /* Landscape mobile adjustments */
        @media (max-width: 767px) and (orientation: landscape) {
          .hero-section {
            padding: var(--space-20) var(--space-16);
            margin-bottom: var(--space-24);
          }
          
          .hero-record-btn {
            height: 80px;
            width: 250px;
          }
          
          .content-page {
            padding: var(--space-16) var(--space-16);
          }
          
          .quick-setup {
            margin-bottom: var(--space-24);
          }
        }
        
        /* Focus improvements for mobile */
        @media (max-width: 767px) {
          .form-control:focus,
          .btn:focus,
          .speaker-tag:focus,
          .nav-item:focus {
            outline: 3px solid #007AFF;
            outline-offset: 2px;
          }
          
          /* Add safe area for notch devices */
          .app-header {
            padding-top: env(safe-area-inset-top, var(--space-16));
          }
          
          .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom, var(--space-12));
          }
          
          /* Improve button hover states on touch devices */
          .btn:active {
            transform: scale(0.98);
          }
          
          .hero-record-btn:active {
            transform: scale(0.96);
          }
          
          .nav-item:active {
            background-color: var(--color-secondary);
          }
        }
        
        /* Loading states */
        .loading {
          opacity: 0.6;
          pointer-events: none;
        }
        
        .loading::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 20px;
          height: 20px;
          margin: -10px 0 0 -10px;
          border: 2px solid #007AFF;
          border-top-color: transparent;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }
        
        /* Error states */
        .error-message {
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: #FF3B30;
          color: white;
          padding: var(--space-12) var(--space-20);
          border-radius: var(--radius-base);
          font-size: 14px;
          max-width: 90%;
          z-index: 1001;
          animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
          from {
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
          }
          to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
          }
        }
        
        /* Success states */
        .success-message {
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: #34C759;
          color: white;
          padding: var(--space-12) var(--space-20);
          border-radius: var(--radius-base);
          font-size: 14px;
          max-width: 90%;
          z-index: 1001;
          animation: slideDown 0.3s ease-out;
        }
        
        /* Permission request styling */
        .permission-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
        
        .permission-dialog {
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          padding: var(--space-24);
          max-width: 90%;
          text-align: center;
        }
        
        .permission-dialog h3 {
          margin-bottom: var(--space-16);
          color: var(--color-text);
        }
        
        .permission-dialog p {
          color: var(--color-text-secondary);
          margin-bottom: var(--space-20);
          line-height: 1.5;
        }

        /* Meeting Setup Form */
        .meeting-form {
          max-width: 600px;
        }

        .form-row {
          display: flex;
          gap: var(--space-16);
        }

        .form-row .form-group {
          flex: 1;
        }

        /* Attendees List */
        .attendee-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: var(--space-8) var(--space-12);
          border-radius: var(--radius-base);
          margin-bottom: var(--space-8);
          background: var(--color-bg-2);
        }

        .attendee-info {
          display: flex;
          align-items: center;
          gap: var(--space-8);
        }

        .attendee-color {
          width: 12px;
          height: 12px;
          border-radius: 50%;
        }

        .attendee-name {
          font-weight: var(--font-weight-medium);
        }

        .attendee-role {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        .attendee-status {
          font-size: var(--font-size-xs);
          padding: var(--space-2) var(--space-6);
          border-radius: var(--radius-sm);
          background: var(--color-success);
          color: white;
        }

        .attendee-status.absent {
          background: var(--color-error);
        }

        /* Speaker List */
        .speaker-item {
          display: flex;
          align-items: center;
          padding: var(--space-8);
          border-radius: var(--radius-base);
          margin-bottom: var(--space-8);
          cursor: pointer;
          transition: background var(--duration-fast) var(--ease-standard);
        }

        .speaker-item:hover {
          background: var(--color-secondary);
        }

        .speaker-color {
          width: 16px;
          height: 16px;
          border-radius: 50%;
          margin-right: var(--space-8);
        }

        .speaker-name {
          flex: 1;
          font-weight: var(--font-weight-medium);
        }

        .speaker-time {
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
        }

        /* Transcript Editor */
        .transcript-editor {
          min-height: 300px;
          max-height: 600px;
          overflow-y: auto;
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          padding: var(--space-20);
          background: var(--color-surface);
          line-height: 1.6;
        }

        .transcript-entry {
          margin-bottom: var(--space-20);
          padding: var(--space-16);
          border-radius: var(--radius-base);
          border-left: 3px solid var(--color-primary);
          background: var(--color-bg-1);
        }

        .transcript-meta {
          display: flex;
          align-items: center;
          gap: var(--space-10);
          margin-bottom: var(--space-12);
          flex-wrap: wrap;
        }

        .speaker-tag {
          background: var(--color-primary);
          color: white;
          padding: var(--space-6) var(--space-12);
          border-radius: var(--radius-sm);
          font-size: 14px;
          font-weight: var(--font-weight-medium);
          cursor: pointer;
          min-height: 32px;
          display: inline-flex;
          align-items: center;
        }

        .timestamp {
          font-size: 12px;
          color: var(--color-text-secondary);
          font-family: var(--font-family-mono);
          white-space: nowrap;
        }

        .transcript-text {
          line-height: 1.6;
          color: var(--color-text);
          font-size: 16px;
          margin-top: var(--space-8);
        }

        /* Action Items */
        .action-item {
          background: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          padding: var(--space-16);
          margin-bottom: var(--space-12);
        }

        .action-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: var(--space-8);
        }

        .action-priority {
          padding: var(--space-2) var(--space-8);
          border-radius: var(--radius-sm);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-medium);
        }

        .priority-high { background: var(--color-error); color: white; }
        .priority-medium { background: var(--color-warning); color: white; }
        .priority-low { background: var(--color-success); color: white; }

        .action-assignee {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        .action-due {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        /* Status indicators */
        .status {
          display: inline-flex;
          align-items: center;
          padding: var(--space-6) var(--space-12);
          border-radius: var(--radius-full);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }
        
        .status--success {
          background-color: rgba(
            var(--color-success-rgb, 33, 128, 141),
            var(--status-bg-opacity)
          );
          color: var(--color-success);
          border: 1px solid
            rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
        }
        
        .status--error {
          background-color: rgba(
            var(--color-error-rgb, 192, 21, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-error);
          border: 1px solid
            rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
        }
        
        .status--warning {
          background-color: rgba(
            var(--color-warning-rgb, 168, 75, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-warning);
          border: 1px solid
            rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
        }
        
        .status--info {
          background-color: rgba(
            var(--color-info-rgb, 98, 108, 113),
            var(--status-bg-opacity)
          );
          color: var(--color-info);
          border: 1px solid
            rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
        }

        /* Templates */
        .template-option {
          padding: var(--space-12);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          margin-bottom: var(--space-8);
          cursor: pointer;
          transition: all var(--duration-fast) var(--ease-standard);
        }

        .template-option:hover {
          border-color: var(--color-primary);
          background: var(--color-bg-1);
        }

        .template-option.selected {
          border-color: var(--color-primary);
          background: var(--color-bg-1);
        }

        .template-name {
          font-weight: var(--font-weight-medium);
          margin-bottom: var(--space-4);
        }

        .template-description {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        /* Enhanced confidence indicators */
        .low-confidence {
          border: 1px dashed var(--color-warning) !important;
        }
        
        .medium-confidence {
          border: 1px solid var(--color-info) !important;
        }
        
        .high-confidence {
          border: 1px solid var(--color-success) !important;
        }
        
        /* Punctuation confidence indicators */
        .punctuation-auto {
          background: #E3F2FD;
          padding: 1px 2px;
          border-radius: 2px;
          position: relative;
          transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .punctuation-high-confidence {
          background: rgba(var(--color-success-rgb), 0.15);
          border-bottom: 1px solid var(--color-success);
        }
        
        .punctuation-medium-confidence {
          background: rgba(var(--color-warning-rgb), 0.15);
          border-bottom: 1px solid var(--color-warning);
        }
        
        .punctuation-low-confidence {
          background: rgba(var(--color-error-rgb), 0.15);
          border-bottom: 1px dashed var(--color-error);
          cursor: pointer;
          animation: pulse-uncertain 2s infinite;
        }
        
        .punctuation-low-confidence:hover {
          background: rgba(var(--color-error-rgb), 0.25);
          transform: scale(1.1);
        }
        
        .punctuation-manual {
          background: rgba(var(--color-teal-500-rgb), 0.2);
          border-bottom: 1px solid var(--color-teal-500);
          color: var(--color-teal-700);
        }
        
        .punctuation-suggestion {
          color: var(--color-primary);
          background: rgba(var(--color-primary), 0.1);
          border-radius: 2px;
          padding: 1px 2px;
          cursor: pointer;
          text-decoration: underline;
          text-decoration-style: dotted;
          transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .punctuation-suggestion:hover {
          background: rgba(var(--color-primary), 0.2);
          transform: scale(1.05);
        }
        
        @keyframes pulse-uncertain {
          0%, 100% { 
            opacity: 0.8;
            transform: scale(1);
          }
          50% { 
            opacity: 1;
            transform: scale(1.02);
          }
        }
        
        /* Punctuation menu */
        .punctuation-menu {
          animation: slideUp 0.2s ease-out;
        }
        
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        @media (prefers-color-scheme: dark) {
          .punctuation-auto {
            background: rgba(var(--color-teal-300-rgb), 0.1);
          }
          
          .punctuation-manual {
            color: var(--color-teal-300);
          }
        }
        
        .current-speaker {
          background: var(--color-bg-1) !important;
          border: 2px solid var(--color-primary) !important;
        }
        
        .transcript-text:focus {
          background: var(--color-bg-1);
          outline: 2px solid var(--color-primary);
          border-radius: var(--radius-sm);
        }
        
        .transcript-entry[data-final="false"] {
          background: linear-gradient(45deg, transparent, var(--color-bg-2));
          animation: interim-pulse 2s infinite;
        }
        
        @keyframes interim-pulse {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 0.8; }
        }

        /* Utility classes */
        .flex {
          display: flex;
        }
        .flex-col {
          flex-direction: column;
        }
        .items-center {
          align-items: center;
        }
        .justify-center {
          justify-content: center;
        }
        .justify-between {
          justify-content: space-between;
        }
        .gap-4 {
          gap: var(--space-4);
        }
        .gap-8 {
          gap: var(--space-8);
        }
        .gap-16 {
          gap: var(--space-16);
        }
        
        .m-0 {
          margin: 0;
        }
        .mt-8 {
          margin-top: var(--space-8);
        }
        .mb-8 {
          margin-bottom: var(--space-8);
        }
        .mx-8 {
          margin-left: var(--space-8);
          margin-right: var(--space-8);
        }
        .my-8 {
          margin-top: var(--space-8);
          margin-bottom: var(--space-8);
        }
        
        .p-0 {
          padding: 0;
        }
        .py-8 {
          padding-top: var(--space-8);
          padding-bottom: var(--space-8);
        }
        .px-8 {
          padding-left: var(--space-8);
          padding-right: var(--space-8);
        }
        .py-16 {
          padding-top: var(--space-16);
          padding-bottom: var(--space-16);
        }
        .px-16 {
          padding-left: var(--space-16);
          padding-right: var(--space-16);
        }
        
        .block {
          display: block;
        }
        .hidden {
          display: none;
        }

        .text-center {
          text-align: center;
        }

        .w-full {
          width: 100%;
        }

        .editable {
          cursor: pointer;
          padding: var(--space-2) var(--space-4);
          border-radius: var(--radius-sm);
          transition: background var(--duration-fast);
        }

        .editable:hover {
          background: var(--color-secondary);
        }

        .editing {
          background: var(--color-surface);
          border: 1px solid var(--color-primary);
          outline: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Simple Header -->
        <div class="widget-header">
            <div class="widget-title">🎤 Transcribe</div>
            <div class="widget-controls">
                <button class="btn-icon" onclick="copyTranscript()" title="Copy transcript">📋</button>
                <button class="btn-icon" onclick="exportOptions.toggle()" title="Export options">📤</button>
            </div>
        </div>

        <!-- Main Widget Content -->
        <div class="widget-body">
            <!-- Recording Section -->
            <div class="record-section">
                <button id="record-button" class="record-button idle" onclick="toggleRecording()">
                    <div class="record-icon">🎤</div>
                    <div class="record-text" id="record-text">Start Recording</div>
                </button>
                
                <!-- Permission Status Display -->
                <div id="permission-status" class="permission-status" style="margin-top: var(--space-16); padding: var(--space-12); border-radius: var(--radius-base); background: var(--color-bg-1); text-align: center; font-size: 14px; display: none;">
                    <span id="permission-icon">?</span>
                    <span id="permission-message">Checking microphone access...</span>
                    <button id="permission-action" onclick="requestMicrophoneAccess()" style="display: none; margin-left: var(--space-8); padding: var(--space-4) var(--space-8); border: none; background: var(--color-primary); color: white; border-radius: var(--radius-sm); cursor: pointer;">Enable</button>
                </div>
                
                <div class="recording-info" id="recording-info" style="display: none;">
                    <div class="timer" id="timer">00:00</div>
                    <div class="status" id="status">Ready to record...</div>
                    <div class="audio-level" id="audio-level">
                        <div class="level-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Live Transcript Section -->
            <div class="transcript-section">
                <div class="transcript-header">
                    <div class="transcript-title">Live Transcript</div>
                    <div class="word-count" id="word-count">0 words</div>
                </div>
                
                <div class="transcript-container" id="transcript-container">
                    <div class="transcript-content" id="transcript" contenteditable="true" spellcheck="true">
                        <p class="placeholder">Click "Start Recording" and begin speaking...</p>
                    </div>
                </div>
            </div>

            <!-- Export Panel -->
            <div class="export-panel" id="export-panel" style="display: none;">
                <div class="export-header">
                    <div class="export-title">Export Options</div>
                    <button class="btn-close" onclick="exportOptions.hide()">✕</button>
                </div>
                
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportAsText()">
                        <div class="btn-icon">📝</div>
                        <div class="btn-label">Text File</div>
                    </button>
                    
                    <button class="export-btn" onclick="exportAsPDF()">
                        <div class="btn-icon">📄</div>
                        <div class="btn-label">PDF</div>
                    </button>
                    
                    <button class="export-btn" onclick="shareTranscript()" id="share-btn" style="display: none;">
                        <div class="btn-icon">📤</div>
                        <div class="btn-label">Share</div>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settings-panel" style="display: none;">
                <div class="settings-header">
                    <div class="settings-title">Settings</div>
                    <button class="btn-close" onclick="hideSettings()">✕</button>
                </div>
                
                <div class="settings-content">
                    <div class="setting-group">
                        <label>Language</label>
                        <select id="language-select" onchange="updateLanguage(this.value)">
                            <option value="en-US" selected>English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>Font Size</label>
                        <select id="font-size-select" onchange="updateFontSize(this.value)">
                            <option value="16">Small</option>
                            <option value="18" selected>Medium</option>
                            <option value="20">Large</option>
                            <option value="22">Extra Large</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="auto-punctuation" checked onchange="updatePunctuationSettings()">
                            Auto Punctuation
                        </label>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="confidence-indicator" checked>
                            Show Confidence Indicators
                        </label>
                    </div>
                    
                    <div class="setting-group">
                        <label>Punctuation Sensitivity</label>
                        <select id="punctuation-sensitivity" onchange="updatePunctuationSensitivity(this.value)">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="highlight-punctuation" checked onchange="updatePunctuationSettings()">
                            Highlight Auto-Added Punctuation
                        </label>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="punctuation-confidence" checked onchange="updatePunctuationSettings()">
                            Show Punctuation Confidence
                        </label>
                    </div>
                </div>
            </div>


        </div>
        
        <!-- Settings Toggle -->
        <button class="settings-toggle" onclick="showSettings()" title="Settings">⚙️</button>
    </div>

    <script>
        // Enhanced Widget State with robust microphone support
        let transcribeState = {
            isRecording: false,
            isPaused: false,
            startTime: null,
            mediaRecorder: null,
            audioStream: null,
            speechRecognition: null,
            audioChunks: [],
            interimTranscript: '',
            finalTranscript: '',
            language: 'en-US',
            confidenceThreshold: 0.7,
            wordCount: 0,
            duration: 0,
            audioLevel: 0,
            microphonePermission: 'prompt',
            speechRecognitionSupported: false,
            isHTTPS: false,
            retryAttempts: 0,
            maxRetryAttempts: 3,
            retryDelay: 1000,
            speechRestartAttempts: 0,
            maxSpeechRestartAttempts: 5,
            shouldContinueRecording: false,
            recognitionActive: false,
            lastPauseTime: 0,
            speechStartTime: 0,
            punctuationEngine: null,
            settings: {
                autoPunctuation: true,
                showConfidence: true,
                fontSize: 18,
                punctuationSensitivity: 'medium',
                highlightAutoPunctuation: true,
                showPunctuationConfidence: true
            },
            browserInfo: {
                name: '',
                version: '',
                isMobile: false,
                isIOSSafari: false,
                isAndroidChrome: false
            },
            diagnostics: {
                microphoneAvailable: false,
                speechRecognitionAvailable: false,
                httpsRequired: true,
                lastError: null,
                permissionState: 'unknown'
            }
        };
        
        // Widget API for parent page communication
        class TranscribeWidget {
            constructor() {
                this.listeners = new Map();
                this.setupPostMessage();
            }
            
            // Event system for integration
            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }
            
            emit(event, data) {
                // Send to parent page via postMessage
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'transcribe-widget',
                        event: event,
                        data: data
                    }, '*');
                }
                
                // Trigger internal listeners
                const eventListeners = this.listeners.get(event) || [];
                eventListeners.forEach(callback => callback(data));
            }
            
            setupPostMessage() {
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'transcribe-widget-command') {
                        this.handleCommand(event.data.command, event.data.params);
                    }
                });
            }
            
            handleCommand(command, params) {
                switch(command) {
                    case 'start':
                        startRecording();
                        break;
                    case 'stop':
                        stopRecording();
                        break;
                    case 'getTranscript':
                        return getTranscript();
                    case 'clearTranscript':
                        clearTranscript();
                        break;
                    case 'setLanguage':
                        updateLanguage(params.language);
                        break;
                }
            }
            
            // Public API methods
            getTranscript() {
                return document.getElementById('transcript').textContent.trim();
            }
            
            getWordCount() {
                return transcribeState.wordCount;
            }
            
            getDuration() {
                return transcribeState.duration;
            }
            
            isRecording() {
                return transcribeState.isRecording;
            }
        }
        
        // Initialize widget API
        const widget = new TranscribeWidget();

        // Initialize the bulletproof widget with comprehensive checks
        async function init() {
            // Detect browser and device information
            detectBrowserInfo();
            
            // Check HTTPS requirement
            checkHTTPSRequirement();
            
            // Check comprehensive browser support
            await checkComprehensiveBrowserSupport();
            
            // Check microphone permissions
            await checkMicrophonePermissions();
            
            // Initialize punctuation engine
            initializePunctuationEngine();
            
            // Initialize components
            setupEnhancedSpeechRecognition();
            setupAudioVisualization();
            setupKeyboardShortcuts();
            
            // Apply mobile optimizations
            applyMobileOptimizations();
            setupOrientationHandling();
            
            // Show diagnostics
            updateDiagnosticsDisplay();
            
            // Initialize elements
            const transcript = document.getElementById('transcript');
            if (transcript) {
                transcript.addEventListener('input', updateWordCount);
                transcript.addEventListener('paste', handlePaste);
            }
            
            // Check for Web Share API support
            if (navigator.share) {
                document.getElementById('share-btn').style.display = 'block';
            }
            
            // Emit ready event
            widget.emit('ready', { version: '1.0' });
        }
        










        // === PUNCTUATION ENGINE ===
        
        class PunctuationEngine {
            constructor() {
                this.pauseThreshold = {
                    comma: 300,     // 300ms pause suggests comma
                    period: 800,    // 800ms pause suggests sentence end
                    question: 600,  // 600ms with rising intonation
                    exclamation: 500 // 500ms with emphasis
                };
                
                this.confidenceLevels = {
                    high: 0.9,    // Very confident in punctuation choice
                    medium: 0.7,  // Somewhat confident
                    low: 0.5      // Uncertain, show for review
                };
                
                this.questionWords = ['what', 'where', 'when', 'why', 'who', 'how', 'is', 'are', 'do', 'does', 'can', 'could', 'would', 'should', 'will'];
                this.commaPatterns = ['and', 'but', 'or', 'however', 'although', 'because', 'since', 'while', 'before', 'after'];
                this.sentenceEnders = ['however', 'therefore', 'meanwhile', 'finally', 'consequently', 'furthermore', 'moreover'];
                
                this.properNouns = {
                    days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'],
                    months: ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'],
                    titles: ['dr', 'mr', 'mrs', 'ms', 'prof', 'president', 'senator']
                };
                
                this.alwaysCapitalize = ['i', "i'm", "i'll", "i've", "i'd"];
            }
            
            processSpeechResult(transcript, pauseDuration, isInterim, confidence = 1) {
                if (!transcribeState.settings.autoPunctuation) {
                    return { text: transcript, confidence: confidence, punctuationAdded: [] };
                }
                
                if (isInterim) {
                    return this.addInterimPunctuation(transcript, confidence);
                } else {
                    return this.addFinalPunctuation(transcript, pauseDuration, confidence);
                }
            }
            
            addInterimPunctuation(text, confidence) {
                if (!text.trim()) return { text: text, confidence: confidence, punctuationAdded: [] };
                
                let processed = text.toLowerCase().trim();
                const punctuationAdded = [];
                
                // Capitalize first word
                processed = processed.charAt(0).toUpperCase() + processed.slice(1);
                
                // Add question mark if starts with question word
                if (this.startsWithQuestionWord(processed)) {
                    processed += '?';
                    punctuationAdded.push({ type: 'question', confidence: 0.7, position: processed.length - 1 });
                }
                
                // Apply smart capitalization
                processed = this.addSmartCapitalization(processed);
                
                return {
                    text: processed,
                    confidence: confidence,
                    punctuationAdded: punctuationAdded,
                    isInterim: true
                };
            }
            
            addFinalPunctuation(text, pauseDuration, confidence) {
                if (!text.trim()) return { text: text, confidence: confidence, punctuationAdded: [] };
                
                let processed = text.toLowerCase().trim();
                const punctuationAdded = [];
                
                // Capitalize first word
                processed = processed.charAt(0).toUpperCase() + processed.slice(1);
                
                // Apply smart capitalization
                processed = this.addSmartCapitalization(processed);
                
                // Determine punctuation based on pause duration and content
                const sensitivity = this.getSensitivityMultiplier();
                const adjustedThresholds = {
                    comma: this.pauseThreshold.comma * sensitivity,
                    period: this.pauseThreshold.period * sensitivity,
                    question: this.pauseThreshold.question * sensitivity
                };
                
                if (this.isQuestion(processed)) {
                    if (!processed.endsWith('?')) {
                        processed += '?';
                        punctuationAdded.push({ 
                            type: 'question', 
                            confidence: this.calculateQuestionConfidence(processed), 
                            position: processed.length - 1 
                        });
                    }
                } else if (pauseDuration >= adjustedThresholds.period) {
                    if (!processed.match(/[.!?]$/)) {
                        processed += '.';
                        punctuationAdded.push({ 
                            type: 'period', 
                            confidence: this.calculatePeriodConfidence(pauseDuration), 
                            position: processed.length - 1 
                        });
                    }
                } else if (pauseDuration >= adjustedThresholds.comma && this.needsComma(processed)) {
                    if (!processed.match(/[,.;:]$/)) {
                        processed += ',';
                        punctuationAdded.push({ 
                            type: 'comma', 
                            confidence: this.calculateCommaConfidence(processed, pauseDuration), 
                            position: processed.length - 1 
                        });
                    }
                }
                
                return {
                    text: processed,
                    confidence: confidence,
                    punctuationAdded: punctuationAdded,
                    isInterim: false
                };
            }
            
            getSensitivityMultiplier() {
                const sensitivity = transcribeState.settings.punctuationSensitivity;
                switch (sensitivity) {
                    case 'low': return 1.5;    // Less sensitive, longer pauses required
                    case 'high': return 0.7;   // More sensitive, shorter pauses trigger punctuation
                    case 'medium':
                    default: return 1.0;       // Default sensitivity
                }
            }
            
            isQuestion(text) {
                const words = text.split(' ');
                const firstWord = words[0].toLowerCase();
                
                // Check if starts with question words
                if (this.questionWords.includes(firstWord)) {
                    return true;
                }
                
                // Check for question patterns
                return text.includes('or not') || 
                       text.includes('right?') ||
                       text.includes('isn\'t it') ||
                       text.includes('don\'t you') ||
                       this.hasQuestionPattern(text);
            }
            
            hasQuestionPattern(text) {
                const questionPatterns = [
                    /\b(is|are|was|were|do|does|did|can|could|would|should|will|shall)\s+you\b/i,
                    /\bhow\s+(much|many|often|long)\b/i,
                    /\bwhat\s+(is|are|was|were|do|did)\b/i
                ];
                
                return questionPatterns.some(pattern => pattern.test(text));
            }
            
            needsComma(text) {
                // Check for common comma patterns
                return this.commaPatterns.some(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'i');
                    return regex.test(text);
                });
            }
            
            startsWithQuestionWord(text) {
                const firstWord = text.split(' ')[0].toLowerCase();
                return this.questionWords.includes(firstWord);
            }
            
            addSmartCapitalization(text) {
                // Capitalize "I" when standalone
                text = text.replace(/\bi\b/g, 'I');
                
                // Capitalize contractions with "I"
                this.alwaysCapitalize.forEach(word => {
                    const regex = new RegExp(`\\b${word.replace("'", "\\'")}\\b`, 'gi');
                    text = text.replace(regex, word.charAt(0).toUpperCase() + word.slice(1));
                });
                
                // Capitalize days of the week
                this.properNouns.days.forEach(day => {
                    const regex = new RegExp(`\\b${day}\\b`, 'gi');
                    text = text.replace(regex, day.charAt(0).toUpperCase() + day.slice(1));
                });
                
                // Capitalize months
                this.properNouns.months.forEach(month => {
                    const regex = new RegExp(`\\b${month}\\b`, 'gi');
                    text = text.replace(regex, month.charAt(0).toUpperCase() + month.slice(1));
                });
                
                // Capitalize titles
                this.properNouns.titles.forEach(title => {
                    const regex = new RegExp(`\\b${title}\\b`, 'gi');
                    text = text.replace(regex, title.charAt(0).toUpperCase() + title.slice(1));
                });
                
                return text;
            }
            
            calculateQuestionConfidence(text) {
                let confidence = 0.5;
                
                // Higher confidence if starts with question word
                if (this.startsWithQuestionWord(text)) {
                    confidence += 0.3;
                }
                
                // Higher confidence for common question patterns
                if (this.hasQuestionPattern(text)) {
                    confidence += 0.2;
                }
                
                return Math.min(confidence, 1.0);
            }
            
            calculatePeriodConfidence(pauseDuration) {
                const threshold = this.pauseThreshold.period * this.getSensitivityMultiplier();
                
                if (pauseDuration >= threshold * 1.5) {
                    return 0.9; // Very long pause, high confidence
                } else if (pauseDuration >= threshold * 1.2) {
                    return 0.7; // Long pause, medium confidence
                } else {
                    return 0.5; // Just above threshold, low confidence
                }
            }
            
            calculateCommaConfidence(text, pauseDuration) {
                let confidence = 0.3;
                
                // Higher confidence if contains comma patterns
                if (this.needsComma(text)) {
                    confidence += 0.3;
                }
                
                // Adjust based on pause duration
                const threshold = this.pauseThreshold.comma * this.getSensitivityMultiplier();
                if (pauseDuration >= threshold * 1.5) {
                    confidence += 0.2;
                }
                
                return Math.min(confidence, 0.8);
            }
        }
        
        // Initialize Punctuation Engine
        function initializePunctuationEngine() {
            transcribeState.punctuationEngine = new PunctuationEngine();
            console.log('✓ Punctuation engine initialized');
        }
        
        // === COMPREHENSIVE MICROPHONE ACCESS FUNCTIONS ===
        
        // Browser and Device Detection
        function detectBrowserInfo() {
            const userAgent = navigator.userAgent;
            const info = transcribeState.browserInfo;
            
            // Detect mobile devices
            info.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            info.isIOSSafari = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            info.isAndroidChrome = /Android/.test(userAgent) && /Chrome/.test(userAgent);
            
            // Detect browser type
            if (userAgent.includes('Chrome')) {
                info.name = 'Chrome';
                info.version = userAgent.match(/Chrome\/([\d.]+)/)?.[1] || 'unknown';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                info.name = 'Safari';
                info.version = userAgent.match(/Version\/([\d.]+)/)?.[1] || 'unknown';
            } else if (userAgent.includes('Firefox')) {
                info.name = 'Firefox';
                info.version = userAgent.match(/Firefox\/([\d.]+)/)?.[1] || 'unknown';
            } else if (userAgent.includes('Edge')) {
                info.name = 'Edge';
                info.version = userAgent.match(/Edge\/([\d.]+)/)?.[1] || 'unknown';
            } else {
                info.name = 'Unknown';
                info.version = 'unknown';
            }
            
            console.log('Browser detected:', info);
        }
        
        // HTTPS Requirement Check
        function checkHTTPSRequirement() {
            transcribeState.isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            transcribeState.diagnostics.httpsRequired = !transcribeState.isHTTPS;
            
            if (!transcribeState.isHTTPS) {
                showError('Microphone access requires a secure connection (HTTPS). Please access this page using https:// instead of http://');
            }
            
            return transcribeState.isHTTPS;
        }
        
        // Comprehensive Browser Support Check
        async function checkComprehensiveBrowserSupport() {
            const diagnostics = transcribeState.diagnostics;
            
            // Check getUserMedia support
            diagnostics.microphoneAvailable = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            // Check Speech Recognition support
            diagnostics.speechRecognitionAvailable = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
            
            // Specific browser warnings
            const info = transcribeState.browserInfo;
            
            if (info.name === 'Firefox') {
                showWarning('Firefox has limited speech recognition support. Chrome or Safari is recommended for the best experience.');
            }
            
            if (info.isIOSSafari && parseFloat(info.version) < 14.1) {
                showError('iOS Safari 14.1 or later is required for speech recognition. Please update your browser.');
            }
            
            if (!diagnostics.microphoneAvailable) {
                showError('Microphone access is not supported in this browser. Please use Chrome, Safari, or Edge.');
            }
            
            return {
                microphoneSupported: diagnostics.microphoneAvailable,
                speechSupported: diagnostics.speechRecognitionAvailable,
                fullySupported: diagnostics.microphoneAvailable && diagnostics.speechRecognitionAvailable
            };
        }
        
        // Microphone Permission Management
        async function checkMicrophonePermissions() {
            if (!navigator.permissions) {
                transcribeState.microphonePermission = 'prompt';
                transcribeState.diagnostics.permissionState = 'unknown';
                return 'prompt';
            }
            
            try {
                const result = await navigator.permissions.query({ name: 'microphone' });
                transcribeState.microphonePermission = result.state;
                transcribeState.diagnostics.permissionState = result.state;
                
                // Listen for permission changes
                result.addEventListener('change', () => {
                    transcribeState.microphonePermission = result.state;
                    transcribeState.diagnostics.permissionState = result.state;
                    updatePermissionStatus(result.state);
                });
                
                updatePermissionStatus(result.state);
                return result.state;
                
            } catch (error) {
                console.warn('Permission query failed:', error);
                transcribeState.microphonePermission = 'prompt';
                transcribeState.diagnostics.permissionState = 'unknown';
                return 'prompt';
            }
        }
        
        function updatePermissionStatus(state) {
            const statusElement = document.getElementById('status');
            const permissionStatus = document.getElementById('permission-status');
            const permissionIcon = document.getElementById('permission-icon');
            const permissionMessage = document.getElementById('permission-message');
            const permissionAction = document.getElementById('permission-action');
            
            if (permissionStatus && permissionIcon && permissionMessage) {
                permissionStatus.style.display = 'block';
                
                switch (state) {
                    case 'granted':
                        permissionIcon.textContent = '✓';
                        permissionIcon.style.color = 'var(--color-success)';
                        permissionMessage.textContent = 'Microphone access granted - Ready to record';
                        permissionStatus.style.background = 'var(--color-bg-3)';
                        if (permissionAction) permissionAction.style.display = 'none';
                        break;
                    case 'denied':
                        permissionIcon.textContent = '✗';
                        permissionIcon.style.color = 'var(--color-error)';
                        permissionMessage.textContent = 'Microphone access denied - Click here to enable';
                        permissionStatus.style.background = 'var(--color-bg-4)';
                        if (permissionAction) {
                            permissionAction.style.display = 'inline-block';
                            permissionAction.textContent = 'Enable in Settings';
                            permissionAction.onclick = () => {
                                showError('Please enable microphone access in your browser settings and refresh the page.');
                            };
                        }
                        break;
                    case 'prompt':
                        permissionIcon.textContent = '?';
                        permissionIcon.style.color = 'var(--color-warning)';
                        permissionMessage.textContent = 'Microphone permission required';
                        permissionStatus.style.background = 'var(--color-bg-2)';
                        if (permissionAction) {
                            permissionAction.style.display = 'inline-block';
                            permissionAction.textContent = 'Request Access';
                            permissionAction.onclick = () => requestMicrophoneAccess();
                        }
                        break;
                }
            }
            
            // Also update the main status if not recording
            if (statusElement && !transcribeState.isRecording) {
                switch (state) {
                    case 'granted':
                        statusElement.innerHTML = '✓ Ready to record';
                        statusElement.style.color = 'var(--color-success)';
                        break;
                    case 'denied':
                        statusElement.innerHTML = '✗ Microphone access denied';
                        statusElement.style.color = 'var(--color-error)';
                        break;
                    case 'prompt':
                        statusElement.innerHTML = '? Click "Start Recording" to begin';
                        statusElement.style.color = 'var(--color-text-secondary)';
                        break;
                }
            }
        }
        
        // Request Microphone Access with Robust Error Handling
        async function requestMicrophoneAccess() {
            if (transcribeState.microphonePermission === 'granted') {
                return true;
            }
            
            if (transcribeState.microphonePermission === 'denied') {
                showError('Microphone access was previously denied. Please enable it in your browser settings.');
                return false;
            }
            
            try {
                // Try to get temporary access to trigger permission prompt
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                transcribeState.microphonePermission = 'granted';
                return true;
                
            } catch (error) {
                transcribeState.microphonePermission = 'denied';
                transcribeState.diagnostics.lastError = error.message;
                
                switch (error.name) {
                    case 'NotAllowedError':
                        showError('Microphone access was denied. Please click "Allow" when prompted, or enable microphone permissions in your browser settings.');
                        break;
                    case 'NotFoundError':
                        showError('No microphone found. Please connect a microphone and try again.');
                        break;
                    case 'NotReadableError':
                        showError('Microphone is being used by another application. Please close other apps using the microphone and try again.');
                        break;
                    case 'OverconstrainedError':
                        showError('Microphone configuration error. The requested audio settings are not supported.');
                        break;
                    case 'SecurityError':
                        showError('Microphone access blocked due to security restrictions. Please ensure you\'re using HTTPS.');
                        break;
                    default:
                        showError('Failed to access microphone: ' + error.message);
                        break;
                }
                
                return false;
            }
        }
        
        // Enhanced Audio Stream Setup with Retry Logic
        async function getAudioStreamWithRetry() {
            const optimalConstraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 44100,
                    sampleSize: 16,
                    channelCount: 1
                }
            };
            
            const fallbackConstraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: false,
                    autoGainControl: false,
                    sampleRate: 22050,
                    channelCount: 1
                }
            };
            
            const basicConstraints = {
                audio: true
            };
            
            const constraints = [optimalConstraints, fallbackConstraints, basicConstraints];
            
            for (let attempt = 0; attempt < transcribeState.maxRetryAttempts; attempt++) {
                for (let constraintIndex = 0; constraintIndex < constraints.length; constraintIndex++) {
                    try {
                        console.log(`Attempting to get audio stream - Attempt ${attempt + 1}, Constraint set ${constraintIndex + 1}`);
                        
                        const stream = await navigator.mediaDevices.getUserMedia(constraints[constraintIndex]);
                        
                        if (constraintIndex > 0) {
                            showWarning('Using fallback audio settings due to device limitations.');
                        }
                        
                        transcribeState.retryAttempts = 0; // Reset on success
                        return stream;
                        
                    } catch (error) {
                        console.warn(`Audio stream attempt ${attempt + 1}, constraint ${constraintIndex + 1} failed:`, error);
                        
                        if (constraintIndex === constraints.length - 1) {
                            // All constraints failed for this attempt
                            if (attempt < transcribeState.maxRetryAttempts - 1) {
                                // Wait before retrying
                                const delay = transcribeState.retryDelay * Math.pow(2, attempt); // Exponential backoff
                                console.log(`Waiting ${delay}ms before retry...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                            }
                        }
                    }
                }
            }
            
            // All attempts failed
            transcribeState.retryAttempts = transcribeState.maxRetryAttempts;
            throw new Error('Failed to access microphone after multiple attempts with different configurations');
        }
        
        // Enhanced Error Handling
        function handleRecordingError(error) {
            console.error('Recording error:', error);
            transcribeState.diagnostics.lastError = error.message;
            
            // Stop any ongoing recording
            if (transcribeState.isRecording) {
                stopRecording();
            }
            
            // Provide specific error messages and solutions
            if (error.message.includes('microphone after multiple attempts')) {
                showError('Could not access microphone after multiple attempts. Please check your microphone connection and browser permissions.');
            } else if (error.message.includes('HTTPS')) {
                showError('Microphone access requires a secure connection (HTTPS). Please access this page using https:// instead of http://');
            } else {
                showError('Recording failed: ' + error.message);
            }
            
            // Update button state
            updateRecordButton('idle');
        }
        
        // Speech Recognition Error Handling
        function handleSpeechRecognitionError(errorType) {
            console.error('Speech recognition error:', errorType);
            
            switch (errorType) {
                case 'not-allowed':
                    showError('Speech recognition access denied. Please enable microphone permissions in your browser.');
                    break;
                case 'no-speech':
                    console.log('No speech detected, will restart automatically...');
                    // Don't show error for no-speech, just restart
                    if (transcribeState.shouldContinueRecording && transcribeState.speechRestartAttempts < transcribeState.maxSpeechRestartAttempts) {
                        setTimeout(() => startSpeechRecognition(), 1000);
                        transcribeState.speechRestartAttempts++;
                    }
                    break;
                case 'audio-capture':
                    showError('Audio capture failed. Please check your microphone connection.');
                    break;
                case 'network':
                    showWarning('Network connection issue. Trying to reconnect...');
                    if (transcribeState.shouldContinueRecording) {
                        setTimeout(() => startSpeechRecognition(), 2000);
                    }
                    break;
                case 'service-not-allowed':
                    showError('Speech recognition service blocked. Please check browser settings.');
                    break;
                case 'aborted':
                    console.log('Speech recognition was aborted (normal during stop)');
                    break;
                default:
                    console.warn('Speech recognition error:', errorType);
                    if (transcribeState.shouldContinueRecording && transcribeState.speechRestartAttempts < transcribeState.maxSpeechRestartAttempts) {
                        setTimeout(() => startSpeechRecognition(), 1000);
                        transcribeState.speechRestartAttempts++;
                    }
                    break;
            }
        }
        
        // Speech Recognition Restart Logic
        function restartSpeechRecognition() {
            if (transcribeState.speechRestartAttempts >= transcribeState.maxSpeechRestartAttempts) {
                showError('Speech recognition failed to restart after multiple attempts. Recording continues without live transcription.');
                return;
            }
            
            transcribeState.speechRestartAttempts++;
            const delay = 1000 * transcribeState.speechRestartAttempts; // Progressive delay
            
            console.log(`Restarting speech recognition in ${delay}ms (attempt ${transcribeState.speechRestartAttempts})`);
            
            setTimeout(() => {
                if (transcribeState.speechRecognition && transcribeState.isRecording && !transcribeState.isPaused) {
                    startSpeechRecognitionWithRetry();
                }
            }, delay);
        }
        
        function startSpeechRecognition() {
            if (!transcribeState.speechRecognition || !transcribeState.speechRecognitionSupported) {
                console.warn('Speech recognition not available');
                return false;
            }
            
            if (transcribeState.recognitionActive) {
                console.log('Speech recognition already running');
                return true;
            }
            
            try {
                console.log('Starting speech recognition...');
                transcribeState.speechRecognition.start();
                return true;
            } catch (error) {
                console.error('Speech recognition start failed:', error);
                
                if (error.name === 'InvalidStateError') {
                    // Already running, stop and restart
                    console.log('Recognition already running, restarting...');
                    try {
                        transcribeState.speechRecognition.stop();
                        setTimeout(() => {
                            if (transcribeState.shouldContinueRecording) {
                                startSpeechRecognition();
                            }
                        }, 500);
                    } catch (stopError) {
                        console.error('Failed to stop speech recognition:', stopError);
                    }
                } else {
                    handleSpeechRecognitionError(error.name || error.message);
                }
                return false;
            }
        }
        
        function stopSpeechRecognition() {
            if (!transcribeState.speechRecognition) {
                return;
            }
            
            console.log('Stopping speech recognition...');
            transcribeState.shouldContinueRecording = false;
            transcribeState.recognitionActive = false;
            
            try {
                transcribeState.speechRecognition.stop();
            } catch (error) {
                console.error('Error stopping speech recognition:', error);
            }
        }
        
        // Enhanced Transcript Update with Confidence Indicators
        function updateTranscriptWithConfidence(finalText, interimText, results) {
            const transcript = document.getElementById('transcript');
            if (!transcript) return;
            
            // Remove existing interim text
            const existingInterim = transcript.querySelector('.interim');
            if (existingInterim) {
                existingInterim.remove();
            }
            
            // Add final text if provided
            if (finalText.trim()) {
                const finalSpan = document.createElement('span');
                finalSpan.className = 'final';
                
                // Add confidence indicator if enabled
                if (transcribeState.settings.showConfidence && results && results.length > 0) {
                    const confidence = results[results.length - 1][0].confidence || 1;
                    if (confidence < 0.5) {
                        finalSpan.classList.add('low-confidence');
                        finalSpan.title = `Low confidence: ${Math.round(confidence * 100)}%`;
                    } else if (confidence < 0.8) {
                        finalSpan.classList.add('medium-confidence');
                        finalSpan.title = `Medium confidence: ${Math.round(confidence * 100)}%`;
                    } else {
                        finalSpan.classList.add('high-confidence');
                        finalSpan.title = `High confidence: ${Math.round(confidence * 100)}%`;
                    }
                }
                
                finalSpan.textContent = finalText + ' ';
                transcript.appendChild(finalSpan);
                
                transcribeState.finalTranscript += finalText + ' ';
                updateWordCount();
            }
            
            // Add interim text if provided
            if (interimText.trim()) {
                const interimSpan = document.createElement('span');
                interimSpan.className = 'interim';
                interimSpan.textContent = interimText;
                transcript.appendChild(interimSpan);
            }
            
            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }
        
        // Diagnostics Display
        function updateDiagnosticsDisplay() {
            // This can be expanded to show diagnostic information in the UI
            console.log('Microphone Diagnostics:', {
                browserInfo: transcribeState.browserInfo,
                diagnostics: transcribeState.diagnostics,
                isHTTPS: transcribeState.isHTTPS,
                microphonePermission: transcribeState.microphonePermission
            });
        }
        
        // === END COMPREHENSIVE MICROPHONE ACCESS FUNCTIONS ===
        
        // Core Widget Functions
        function toggleRecording() {
            if (!transcribeState.isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                console.log('🎙️ Starting recording...');
                
                // Reset state
                transcribeState.retryAttempts = 0;
                transcribeState.speechRestartAttempts = 0;
                transcribeState.shouldContinueRecording = true;
                
                // Update button to show starting state
                updateRecordButton('processing');
                
                // Check HTTPS requirement first
                if (!transcribeState.isHTTPS) {
                    showError('Microphone access requires a secure connection (HTTPS). Please access this page using https:// instead of http://');
                    updateRecordButton('idle');
                    return;
                }
                
                // Check and request microphone permissions
                console.log('Requesting microphone access...');
                const permissionGranted = await requestMicrophoneAccess();
                if (!permissionGranted) {
                    showError('Microphone access was denied. Please enable microphone permissions in your browser settings.');
                    updateRecordButton('idle');
                    return;
                }
                
                // Get audio stream
                console.log('Getting audio stream...');
                transcribeState.audioStream = await getAudioStreamWithRetry();
                
                if (!transcribeState.audioStream) {
                    showError('Failed to access microphone after multiple attempts.');
                    updateRecordButton('idle');
                    return;
                }
                
                // Setup media recorder
                setupMediaRecorder();
                
                // Setup speech recognition
                console.log('Setting up speech recognition...');
                const speechSetup = await setupEnhancedSpeechRecognition();
                
                // Start recording state
                transcribeState.isRecording = true;
                transcribeState.isPaused = false;
                transcribeState.startTime = Date.now();
                
                // Update UI
                updateRecordButton('recording');
                startTimer();
                startAudioLevelMonitoring();
                
                // Clear placeholder text
                const transcript = document.getElementById('transcript');
                if (transcript && (transcript.textContent.includes('Click "Start Recording"') || transcript.innerHTML.includes('placeholder'))) {
                    transcript.innerHTML = '<span class="interim">Listening...</span>';
                }
                
                // Start speech recognition if available
                if (speechSetup && transcribeState.speechRecognitionSupported) {
                    console.log('Starting speech recognition...');
                    setTimeout(() => {
                        startSpeechRecognition();
                    }, 500); // Small delay to ensure everything is ready
                } else {
                    showWarning('Speech recognition not available. You can still record audio and type manually.');
                }
                
                console.log('✅ Recording started successfully');
                showSuccess('Recording started - speak now!');
                widget.emit('recording-started', { timestamp: transcribeState.startTime });
                
            } catch (error) {
                console.error('❌ Recording start failed:', error);
                handleRecordingError(error);
            }
        }
        
        function stopRecording() {
            console.log('🛑 Stopping recording...');
            
            transcribeState.isRecording = false;
            transcribeState.shouldContinueRecording = false;
            
            updateRecordButton('processing');
            
            // Stop speech recognition first
            stopSpeechRecognition();
            
            // Stop media recorder
            if (transcribeState.mediaRecorder && transcribeState.mediaRecorder.state !== 'inactive') {
                try {
                    transcribeState.mediaRecorder.stop();
                } catch (error) {
                    console.error('Error stopping media recorder:', error);
                }
            }
            
            // Stop audio stream
            if (transcribeState.audioStream) {
                try {
                    transcribeState.audioStream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    console.error('Error stopping audio stream:', error);
                }
                transcribeState.audioStream = null;
            }
            
            // Update UI
            updateRecordButton('idle');
            
            const status = document.getElementById('status');
            if (status) {
                status.textContent = `Recording stopped - ${transcribeState.wordCount} words captured`;
                status.style.color = 'var(--color-text-secondary)';
            }
            
            // Calculate duration
            const duration = transcribeState.startTime ? Date.now() - transcribeState.startTime : 0;
            transcribeState.duration = duration;
            
            console.log('✅ Recording stopped successfully');
            showSuccess(`Recording stopped - ${transcribeState.wordCount} words captured`);
            
            widget.emit('recording-stopped', { 
                duration: duration,
                wordCount: transcribeState.wordCount,
                transcript: getTranscript()
            });
        }
        
        function setupMediaRecorder() {
            if (!transcribeState.audioStream) return;
            
            transcribeState.mediaRecorder = new MediaRecorder(transcribeState.audioStream);
            transcribeState.audioChunks = [];
            
            transcribeState.mediaRecorder.ondataavailable = (event) => {
                transcribeState.audioChunks.push(event.data);
            };
            
            transcribeState.mediaRecorder.start(1000);
        }

        async function setupEnhancedSpeechRecognition() {
            // Check if speech recognition is available
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('Speech recognition not supported in this browser');
                showWarning('Speech recognition is not available in this browser. Try using Chrome or Safari for the best experience. You can still record audio and type notes manually.');
                transcribeState.speechRecognitionSupported = false;
                return false;
            }
            
            console.log('Setting up speech recognition...');
            
            try {
                // Create new instance
                transcribeState.speechRecognition = new SpeechRecognition();
                
                // Configure BEFORE adding event handlers
                transcribeState.speechRecognition.continuous = true;
                transcribeState.speechRecognition.interimResults = true;
                transcribeState.speechRecognition.lang = transcribeState.language;
                transcribeState.speechRecognition.maxAlternatives = 1;
                
                // iOS Safari specific settings
                if (transcribeState.browserInfo.isIOSSafari) {
                    transcribeState.speechRecognition.continuous = false; // iOS limitation
                }
                
                // Event handlers
                transcribeState.speechRecognition.onstart = () => {
                    console.log('✓ Speech recognition started');
                    transcribeState.recognitionActive = true;
                    transcribeState.speechRestartAttempts = 0;
                    
                    const status = document.getElementById('status');
                    if (status) {
                        status.innerHTML = '<span class="recording-dot"></span> Recording - speak now';
                        status.style.color = 'var(--color-success)';
                    }
                };
                
                transcribeState.speechRecognition.onresult = (event) => {
                    console.log('Speech result received:', event);
                    
                    let interimTranscript = '';
                    let finalTranscript = '';
                    const currentTime = Date.now();
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        const confidence = result[0].confidence || 0.9;
                        
                        if (result.isFinal) {
                            // Calculate pause duration
                            const pauseDuration = transcribeState.lastPauseTime > 0 ? 
                                currentTime - transcribeState.lastPauseTime : 0;
                            
                            // Check for voice punctuation commands
                            const cleanTranscript = processVoicePunctuationCommands(transcript);
                            
                            // Process with punctuation engine
                            if (transcribeState.punctuationEngine && cleanTranscript.trim()) {
                                const processed = transcribeState.punctuationEngine.processSpeechResult(
                                    cleanTranscript, pauseDuration, false, confidence
                                );
                                finalTranscript += processed.text;
                                console.log('Final transcript with punctuation:', processed.text);
                                console.log('Punctuation added:', processed.punctuationAdded);
                                
                                // Store punctuation metadata for confidence display
                                if (processed.punctuationAdded.length > 0) {
                                    storePunctuationMetadata(processed.punctuationAdded);
                                }
                            } else {
                                finalTranscript += cleanTranscript;
                            }
                            
                            transcribeState.lastPauseTime = currentTime;
                        } else {
                            // Process interim results with punctuation engine
                            if (transcribeState.punctuationEngine) {
                                const processed = transcribeState.punctuationEngine.processSpeechResult(
                                    transcript, 0, true, confidence
                                );
                                interimTranscript += processed.text;
                                console.log('Interim transcript with punctuation:', processed.text);
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                    }
                    
                    updateTranscriptWithPunctuation(finalTranscript, interimTranscript, event.results);
                    
                    if (finalTranscript.trim()) {
                        widget.emit('transcript-update', {
                            text: finalTranscript,
                            isFinal: true
                        });
                    }
                };
                
                transcribeState.speechRecognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    transcribeState.recognitionActive = false;
                    handleSpeechRecognitionError(event.error);
                };
                
                transcribeState.speechRecognition.onend = () => {
                    console.log('Speech recognition ended');
                    transcribeState.recognitionActive = false;
                    
                    // Auto-restart if we should continue recording
                    if (transcribeState.shouldContinueRecording && transcribeState.isRecording && !transcribeState.isPaused) {
                        console.log('Auto-restarting speech recognition...');
                        setTimeout(() => {
                            startSpeechRecognition();
                        }, 100);
                    }
                };
                
                transcribeState.speechRecognitionSupported = true;
                console.log('✓ Speech recognition setup complete');
                return true;
                
            } catch (error) {
                console.error('Failed to setup speech recognition:', error);
                showError('Speech recognition setup failed: ' + error.message);
                transcribeState.speechRecognitionSupported = false;
                return false;
            }
        }

        function updateTranscript(finalText, interimText) {
            const transcript = document.getElementById('transcript');
            if (!transcript) return;
            
            // Remove existing interim text
            const existingInterim = transcript.querySelector('.interim');
            if (existingInterim) {
                existingInterim.remove();
            }
            
            // Add final text if provided
            if (finalText.trim()) {
                const finalSpan = document.createElement('span');
                finalSpan.className = 'final';
                finalSpan.textContent = finalText + ' ';
                transcript.appendChild(finalSpan);
                
                transcribeState.finalTranscript += finalText + ' ';
                updateWordCount();
            }
            
            // Add interim text if provided
            if (interimText.trim()) {
                const interimSpan = document.createElement('span');
                interimSpan.className = 'interim';
                interimSpan.textContent = interimText;
                transcript.appendChild(interimSpan);
            }
            
            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }
        
        function updateTranscriptWithPunctuation(finalText, interimText, results) {
            const transcript = document.getElementById('transcript');
            if (!transcript) return;
            
            // Remove existing interim text
            const existingInterim = transcript.querySelector('.interim');
            if (existingInterim) {
                existingInterim.remove();
            }
            
            // Add final text if provided
            if (finalText.trim()) {
                const finalSpan = document.createElement('span');
                finalSpan.className = 'final';
                
                // Apply punctuation highlighting if enabled
                if (transcribeState.settings.highlightAutoPunctuation && transcribeState.punctuationEngine) {
                    finalSpan.innerHTML = highlightPunctuation(finalText + ' ');
                } else {
                    finalSpan.textContent = finalText + ' ';
                }
                
                // Add confidence indicator if enabled
                if (transcribeState.settings.showConfidence && results && results.length > 0) {
                    const confidence = results[results.length - 1][0].confidence || 1;
                    if (confidence < 0.5) {
                        finalSpan.classList.add('low-confidence');
                        finalSpan.title = `Low confidence: ${Math.round(confidence * 100)}%`;
                    } else if (confidence < 0.8) {
                        finalSpan.classList.add('medium-confidence');
                        finalSpan.title = `Medium confidence: ${Math.round(confidence * 100)}%`;
                    } else {
                        finalSpan.classList.add('high-confidence');
                        finalSpan.title = `High confidence: ${Math.round(confidence * 100)}%`;
                    }
                }
                
                transcript.appendChild(finalSpan);
                
                transcribeState.finalTranscript += finalText + ' ';
                updateWordCount();
            }
            
            // Add interim text if provided
            if (interimText.trim()) {
                const interimSpan = document.createElement('span');
                interimSpan.className = 'interim';
                
                if (transcribeState.settings.highlightAutoPunctuation && transcribeState.punctuationEngine) {
                    interimSpan.innerHTML = highlightPunctuation(interimText);
                } else {
                    interimSpan.textContent = interimText;
                }
                
                transcript.appendChild(interimSpan);
            }
            
            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }
        
        function highlightPunctuation(text) {
            if (!transcribeState.settings.showPunctuationConfidence) {
                return text;
            }
            
            // Highlight punctuation marks added by the engine
            return text.replace(/([.!?,:;])/g, (match) => {
                // For demo purposes, assume medium confidence
                // In a real implementation, you'd track which punctuation was auto-added
                return `<span class="punctuation-auto punctuation-medium-confidence" title="Auto-added punctuation">${match}</span>`;
            });
        }
        
        function updateRecordButton(state) {
            const button = document.getElementById('record-button');
            const icon = button.querySelector('.record-icon');
            const text = button.querySelector('.record-text');
            const info = document.getElementById('recording-info');
            
            button.className = `record-button ${state}`;
            
            switch (state) {
                case 'idle':
                    icon.textContent = '🎤';
                    text.textContent = 'Start Recording';
                    info.style.display = 'none';
                    break;
                case 'recording':
                    icon.textContent = '⏹️';
                    text.textContent = 'Stop Recording';
                    info.style.display = 'flex';
                    document.getElementById('status').textContent = 'Recording...';
                    break;
                case 'processing':
                    icon.textContent = '⏳';
                    text.textContent = 'Processing...';
                    info.style.display = 'flex';
                    document.getElementById('status').textContent = 'Processing audio...';
                    break;
            }
        }

        function updateWordCount() {
            const transcript = document.getElementById('transcript');
            const wordCountElement = document.getElementById('word-count');
            
            if (transcript && wordCountElement) {
                const text = transcript.textContent.trim();
                const words = text ? text.split(/\s+/).length : 0;
                transcribeState.wordCount = words;
                wordCountElement.textContent = `${words} words`;
            }
        }

        function updateFontSize(size) {
            const transcript = document.getElementById('transcript');
            if (transcript) {
                transcript.style.fontSize = size + 'px';
                transcribeState.settings.fontSize = size;
            }
        }

        function updateLanguage(language) {
            transcribeState.language = language;
            if (transcribeState.speechRecognition) {
                transcribeState.speechRecognition.lang = language;
                // Restart recognition if recording
                if (transcribeState.isRecording) {
                    transcribeState.speechRecognition.stop();
                    setTimeout(() => {
                        if (transcribeState.speechRecognition) {
                            transcribeState.speechRecognition.start();
                        }
                    }, 100);
                }
            }
        }
        
        function updatePunctuationSettings() {
            const autoPunctuation = document.getElementById('auto-punctuation').checked;
            const highlightPunctuation = document.getElementById('highlight-punctuation').checked;
            const punctuationConfidence = document.getElementById('punctuation-confidence').checked;
            
            transcribeState.settings.autoPunctuation = autoPunctuation;
            transcribeState.settings.highlightAutoPunctuation = highlightPunctuation;
            transcribeState.settings.showPunctuationConfidence = punctuationConfidence;
            
            // Re-render existing transcript if highlighting settings changed
            if (transcribeState.finalTranscript) {
                refreshTranscriptDisplay();
            }
        }
        
        function updatePunctuationSensitivity(sensitivity) {
            transcribeState.settings.punctuationSensitivity = sensitivity;
            
            let message = '';
            switch (sensitivity) {
                case 'low':
                    message = 'Punctuation sensitivity set to LOW - longer pauses required';
                    break;
                case 'medium':
                    message = 'Punctuation sensitivity set to MEDIUM - balanced detection';
                    break;
                case 'high':
                    message = 'Punctuation sensitivity set to HIGH - shorter pauses trigger punctuation';
                    break;
            }
            
            showInfo(message);
        }
        
        function refreshTranscriptDisplay() {
            const transcript = document.getElementById('transcript');
            if (!transcript || !transcribeState.finalTranscript) return;
            
            // Get the current transcript text without interim content
            const finalSpans = transcript.querySelectorAll('.final');
            
            finalSpans.forEach(span => {
                const text = span.textContent || span.innerText;
                if (transcribeState.settings.highlightAutoPunctuation) {
                    span.innerHTML = highlightPunctuation(text);
                } else {
                    span.textContent = text;
                }
            });
        }
        
        // Voice Punctuation Commands Support
        function processVoicePunctuationCommands(text) {
            let processedText = text;
            
            // Voice commands for punctuation (case insensitive)
            const punctuationCommands = {
                'period': '.',
                'full stop': '.',
                'comma': ',',
                'question mark': '?',
                'exclamation mark': '!',
                'exclamation point': '!',
                'semicolon': ';',
                'colon': ':',
                'new line': '\n',
                'new paragraph': '\n\n'
            };
            
            // Replace voice commands with actual punctuation
            Object.entries(punctuationCommands).forEach(([command, punctuation]) => {
                const regex = new RegExp(`\\s+${command}\\s*`, 'gi');
                processedText = processedText.replace(regex, punctuation + ' ');
            });
            
            return processedText.trim();
        }
        
        // Store punctuation metadata for confidence indicators
        function storePunctuationMetadata(punctuationData) {
            // Store metadata for later use in confidence display
            if (!transcribeState.punctuationMetadata) {
                transcribeState.punctuationMetadata = [];
            }
            
            punctuationData.forEach(punct => {
                transcribeState.punctuationMetadata.push({
                    ...punct,
                    timestamp: Date.now()
                });
            });
            
            // Keep only recent metadata (last 100 entries)
            if (transcribeState.punctuationMetadata.length > 100) {
                transcribeState.punctuationMetadata = transcribeState.punctuationMetadata.slice(-100);
            }
        }
        
        // Enhanced highlighting with confidence-based coloring
        function highlightPunctuation(text) {
            if (!transcribeState.settings.showPunctuationConfidence) {
                return text;
            }
            
            // Enhanced punctuation highlighting with confidence levels
            return text.replace(/([.!?,:;])(?=\s|$)/g, (match, punct) => {
                // Get confidence level from metadata (simplified for demo)
                const confidence = getLatestPunctuationConfidence(punct);
                
                let confidenceClass = 'punctuation-medium-confidence';
                let title = 'Auto-added punctuation';
                
                if (confidence >= 0.8) {
                    confidenceClass = 'punctuation-high-confidence';
                    title = `High confidence: ${Math.round(confidence * 100)}%`;
                } else if (confidence >= 0.6) {
                    confidenceClass = 'punctuation-medium-confidence';
                    title = `Medium confidence: ${Math.round(confidence * 100)}%`;
                } else if (confidence < 0.6) {
                    confidenceClass = 'punctuation-low-confidence';
                    title = `Low confidence: ${Math.round(confidence * 100)}% - Click to review`;
                }
                
                return `<span class="punctuation-auto ${confidenceClass}" title="${title}" onclick="reviewPunctuation(this)">${match}</span>`;
            });
        }
        
        function getLatestPunctuationConfidence(punctuationType) {
            // Simplified confidence lookup - in a real implementation,
            // this would match specific punctuation instances
            const typeMap = {
                '.': 0.8,
                '?': 0.9,
                '!': 0.7,
                ',': 0.6,
                ':': 0.7,
                ';': 0.5
            };
            
            return typeMap[punctuationType] || 0.7;
        }
        
        // Interactive punctuation review
        function reviewPunctuation(element) {
            if (!element) return;
            
            const punctuation = element.textContent;
            const confidence = element.title;
            
            // Create simple review interface
            const alternatives = getPunctuationAlternatives(punctuation);
            
            if (alternatives.length > 0) {
                showPunctuationMenu(element, alternatives);
            }
        }
        
        function getPunctuationAlternatives(currentPunct) {
            const alternatives = {
                '.': [',', '!', '?', ';', ' (remove)'],
                ',': ['.', ';', ' (remove)'],
                '?': ['.', '!', ' (remove)'],
                '!': ['.', '?', ' (remove)'],
                ':': [';', '.', ' (remove)'],
                ';': [':', ',', '.', ' (remove)']
            };
            
            return alternatives[currentPunct] || [];
        }
        
        function showPunctuationMenu(element, alternatives) {
            // Remove existing menus
            const existingMenu = document.querySelector('.punctuation-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Create popup menu
            const menu = document.createElement('div');
            menu.className = 'punctuation-menu';
            menu.style.cssText = `
                position: absolute;
                background: var(--color-surface);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-base);
                box-shadow: var(--shadow-lg);
                padding: var(--space-8);
                z-index: 1000;
                display: flex;
                gap: var(--space-4);
                font-size: 14px;
            `;
            
            // Add alternative buttons
            alternatives.forEach(alt => {
                const button = document.createElement('button');
                button.textContent = alt === ' (remove)' ? 'Remove' : alt;
                button.className = 'btn btn--sm';
                button.onclick = () => {
                    replacePunctuation(element, alt === ' (remove)' ? '' : alt);
                    menu.remove();
                };
                menu.appendChild(button);
            });
            
            // Position menu near the punctuation
            const rect = element.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        function replacePunctuation(element, newPunctuation) {
            element.textContent = newPunctuation;
            if (newPunctuation === '') {
                element.style.display = 'none';
            }
            
            // Update confidence class based on manual correction
            element.className = 'punctuation-manual';
            element.title = 'Manually corrected';
            
            showSuccess('Punctuation updated');
            
            // Update word count as text has changed
            updateWordCount();
        }

        // Export and Share Functions
        function exportAsText() {
            const transcript = getTranscript();
            if (!transcript.trim()) {
                showError('No transcript to export');
                return;
            }
            
            const blob = new Blob([transcript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            exportOptions.hide();
            widget.emit('export', { type: 'text', content: transcript });
        }
        
        function exportAsPDF() {
            const transcript = getTranscript();
            if (!transcript.trim()) {
                showError('No transcript to export');
                return;
            }
            
            // Simple PDF export using print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Transcript</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                            .header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #666; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Transcript</h1>
                            <p>Generated on ${new Date().toLocaleDateString()}</p>
                            <p>Duration: ${formatDuration(transcribeState.duration)} | Words: ${transcribeState.wordCount}</p>
                        </div>
                        <div class="content">${transcript.replace(/\n/g, '<br>')}</div>
                        <div class="footer">
                            Generated by Transcription Widget
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            exportOptions.hide();
            widget.emit('export', { type: 'pdf', content: transcript });
        }
        
        function shareTranscript() {
            const transcript = getTranscript();
            if (!transcript.trim()) {
                showError('No transcript to share');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'Transcript',
                    text: transcript,
                }).catch(console.error);
            } else {
                copyTranscript();
            }
            
            exportOptions.hide();
        }
        
        function copyTranscript() {
            const transcript = getTranscript();
            if (!transcript.trim()) {
                showError('No transcript to copy');
                return;
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(transcript).then(() => {
                    showSuccess('Transcript copied to clipboard');
                }).catch(() => {
                    showError('Failed to copy transcript');
                });
            } else {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = transcript;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showSuccess('Transcript copied to clipboard');
            }
        }

        // UI Helper Functions
        const exportOptions = {
            toggle() {
                const panel = document.getElementById('export-panel');
                panel.classList.toggle('visible');
            },
            
            show() {
                const panel = document.getElementById('export-panel');
                panel.classList.add('visible');
            },
            
            hide() {
                const panel = document.getElementById('export-panel');
                panel.classList.remove('visible');
            }
        };
        
        function showSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.add('visible');
        }
        
        function hideSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.remove('visible');
        }

        function startMeeting() {
            updateMeetingDisplay();
            switchTab('recording');
            // Auto-focus the recording tab
            document.querySelector('[onclick="switchTab(\'recording\')"]').click();
        }

        // Timer and Audio Monitoring
        function startTimer() {
            const timerInterval = setInterval(() => {
                if (!transcribeState.isRecording) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsed = Date.now() - transcribeState.startTime;
                const formattedTime = formatDuration(elapsed);
                
                const timer = document.getElementById('timer');
                if (timer) {
                    timer.textContent = formattedTime;
                }
            }, 1000);
        }
        
        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startAudioLevelMonitoring() {
            if (!transcribeState.audioStream) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(transcribeState.audioStream);
            source.connect(analyser);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function updateLevel() {
                if (!transcribeState.isRecording) return;
                
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                const level = (average / 255) * 100;
                
                const levelBar = document.querySelector('.level-bar');
                if (levelBar) {
                    levelBar.style.width = level + '%';
                }
                
                requestAnimationFrame(updateLevel);
            }
            
            updateLevel();
        }

        function setupAudioVisualization() {
            // Audio visualization is handled in startAudioLevelMonitoring
        }

        function handlePaste(event) {
            // Allow pasting text into transcript for manual editing
            const paste = (event.clipboardData || window.clipboardData).getData('text');
            
            // Insert at cursor position
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(paste));
                
                // Move cursor to end of pasted text
                range.setStartAfter(range.endContainer);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            updateWordCount();
            event.preventDefault();
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                // Only trigger if not typing in an input field
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                if (event.ctrlKey || event.metaKey) {
                    switch (event.key) {
                        case 'r':
                        case 'R':
                            event.preventDefault();
                            toggleRecording();
                            break;
                        case 'c':
                        case 'C':
                            event.preventDefault();
                            copyTranscript();
                            break;
                        case 's':
                        case 'S':
                            event.preventDefault();
                            exportAsText();
                            break;
                        case 'e':
                        case 'E':
                            event.preventDefault();
                            exportOptions.show();
                            break;
                        case 'p':
                        case 'P':
                            event.preventDefault();
                            togglePunctuationMode();
                            break;
                    }
                }
                
                // Escape key to close panels and menus
                if (event.key === 'Escape') {
                    exportOptions.hide();
                    hideSettings();
                    // Close punctuation menus
                    const punctMenu = document.querySelector('.punctuation-menu');
                    if (punctMenu) punctMenu.remove();
                }
                
                // Spacebar to toggle recording (when not in contenteditable)
                if (event.code === 'Space' && !event.target.isContentEditable) {
                    event.preventDefault();
                    toggleRecording();
                }
                
                // Quick punctuation insertion when editing transcript
                if (event.target.isContentEditable && event.ctrlKey) {
                    switch (event.key) {
                        case '.':
                            event.preventDefault();
                            insertPunctuationAtCursor('.');
                            break;
                        case ',':
                            event.preventDefault();
                            insertPunctuationAtCursor(',');
                            break;
                        case '?':
                            event.preventDefault();
                            insertPunctuationAtCursor('?');
                            break;
                        case '!':
                            event.preventDefault();
                            insertPunctuationAtCursor('!');
                            break;
                    }
                }
            });
        }
        
        function togglePunctuationMode() {
            const autoPunctuation = document.getElementById('auto-punctuation');
            if (autoPunctuation) {
                autoPunctuation.checked = !autoPunctuation.checked;
                updatePunctuationSettings();
                
                const status = autoPunctuation.checked ? 'enabled' : 'disabled';
                showInfo(`Auto punctuation ${status}`);
            }
        }
        
        function insertPunctuationAtCursor(punctuation) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                
                // Create punctuation with manual styling
                const punctSpan = document.createElement('span');
                punctSpan.className = 'punctuation-manual';
                punctSpan.textContent = punctuation;
                punctSpan.title = 'Manually inserted';
                
                range.insertNode(punctSpan);
                
                // Move cursor after punctuation
                range.setStartAfter(punctSpan);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                
                updateWordCount();
            }
        }





        // === MOBILE-SPECIFIC OPTIMIZATIONS ===
        
        // Mobile Browser Optimizations
        function applyMobileOptimizations() {
            const info = transcribeState.browserInfo;
            
            if (info.isMobile) {
                // Add mobile-specific CSS class
                document.body.classList.add('mobile-device');
                
                // iOS Safari specific optimizations
                if (info.isIOSSafari) {
                    // Prevent zoom on input focus
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (viewport) {
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                    
                    // Handle iOS-specific speech recognition limitations
                    transcribeState.settings.iosContinuousMode = false;
                    
                    showInfo('iOS detected: Optimized for mobile speech recognition');
                }
                
                // Android Chrome specific optimizations
                if (info.isAndroidChrome) {
                    // Enable auto-restart for Android
                    transcribeState.settings.androidAutoRestart = true;
                    
                    showInfo('Android Chrome detected: Enhanced continuous recognition enabled');
                }
                
                // Battery optimization for mobile
                enableBatteryOptimization();
                
                // Touch-friendly UI adjustments
                adjustUIForMobile();
            }
        }
        
        function enableBatteryOptimization() {
            // Reduce audio processing frequency on mobile
            if (transcribeState.browserInfo.isMobile) {
                // Lower sample rate for mobile devices to save battery
                transcribeState.settings.mobileSampleRate = 22050;
                
                // Reduce audio level monitoring frequency
                transcribeState.settings.audioLevelUpdateRate = 500; // ms
            }
        }
        
        function adjustUIForMobile() {
            if (transcribeState.browserInfo.isMobile) {
                // Larger touch targets
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 767px) {
                        .btn, .btn-icon {
                            min-height: 48px;
                            min-width: 48px;
                        }
                        .record-button {
                            width: 160px;
                            height: 160px;
                        }
                        .form-control {
                            min-height: 48px;
                            font-size: 16px; /* Prevent zoom on iOS */
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Handle device orientation changes
        function setupOrientationHandling() {
            if (transcribeState.browserInfo.isMobile) {
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        // Recalculate UI dimensions after orientation change
                        if (transcribeState.isRecording) {
                            // Pause and resume to handle potential audio context issues
                            pauseRecording();
                            setTimeout(() => resumeRecording(), 500);
                        }
                    }, 500);
                });
            }
        }
        
        // Pause/Resume functionality for mobile
        function pauseRecording() {
            if (!transcribeState.isRecording) return;
            
            transcribeState.isPaused = true;
            
            if (transcribeState.speechRecognition) {
                transcribeState.speechRecognition.stop();
            }
            
            if (transcribeState.mediaRecorder && transcribeState.mediaRecorder.state === 'recording') {
                transcribeState.mediaRecorder.pause();
            }
            
            updateRecordButton('paused');
            showInfo('Recording paused');
        }
        
        function resumeRecording() {
            if (!transcribeState.isRecording || !transcribeState.isPaused) return;
            
            transcribeState.isPaused = false;
            
            if (transcribeState.mediaRecorder && transcribeState.mediaRecorder.state === 'paused') {
                transcribeState.mediaRecorder.resume();
            }
            
            if (transcribeState.speechRecognitionSupported) {
                startSpeechRecognitionWithRetry();
            }
            
            updateRecordButton('recording');
            showSuccess('Recording resumed');
        }
        
        // === ENHANCED BROWSER SUPPORT CHECK ===
        
        function checkBrowserSupport() {
            const supportStatus = {
                mediaRecorder: typeof MediaRecorder !== 'undefined',
                speechRecognition: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                getUserMedia: navigator.mediaDevices && navigator.mediaDevices.getUserMedia,
                permissions: 'permissions' in navigator,
                vibrate: 'vibrate' in navigator,
                webShare: 'share' in navigator
            };
            
            const info = transcribeState.browserInfo;
            
            // Browser-specific warnings and optimizations
            if (info.name === 'Chrome' && parseFloat(info.version) < 47) {
                showError('Chrome 47 or later is required. Please update your browser.');
            }
            
            if (info.name === 'Safari' && parseFloat(info.version) < 14.1) {
                showError('Safari 14.1 or later is required for full functionality. Please update your browser.');
            }
            
            if (info.name === 'Firefox') {
                showWarning('Firefox has limited speech recognition support. Chrome or Safari is recommended.');
            }
            
            if (info.name === 'Edge' && parseFloat(info.version) < 79) {
                showError('Edge 79 or later is required. Please update your browser.');
            }
            
            // Feature-specific warnings
            if (!supportStatus.getUserMedia) {
                showError('Microphone access is not supported in this browser. Please use Chrome, Safari, or Edge.');
            }
            
            if (!supportStatus.speechRecognition) {
                showWarning('Speech recognition is not available in this browser. You can still record audio and type notes manually.');
            }
            
            if (!supportStatus.permissions && info.isMobile) {
                showWarning('Permission management is limited in this browser. Some features may require manual setup.');
            }
            
            // Show browser compatibility status
            displayBrowserCompatibility(supportStatus);
            
            return supportStatus;
        }
        
        function displayBrowserCompatibility(supportStatus) {
            const info = transcribeState.browserInfo;
            let compatibilityMessage = `Browser: ${info.name} ${info.version}`;
            
            if (info.isMobile) {
                compatibilityMessage += ' (Mobile)';
            }
            
            const features = [];
            if (supportStatus.getUserMedia) features.push('✓ Microphone');
            else features.push('✗ Microphone');
            
            if (supportStatus.speechRecognition) features.push('✓ Speech Recognition');
            else features.push('✗ Speech Recognition');
            
            if (supportStatus.webShare) features.push('✓ Web Share');
            
            compatibilityMessage += `<br>Features: ${features.join(', ')}`;
            
            // Update status display
            const status = document.getElementById('status');
            if (status && !transcribeState.isRecording) {
                status.innerHTML = compatibilityMessage;
                status.style.color = 'var(--color-text-secondary)';
                status.style.fontSize = '12px';
            }
        }
        
        // Error Handling
        function showError(message) {
            console.error(message);
            
            // Show error in UI
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
                status.style.color = 'var(--color-error)';
            }
            
            // Create toast notification
            createToast(message, 'error');
            
            widget.emit('error', { message });
        }
        
        function showWarning(message) {
            console.warn(message);
            createToast(message, 'warning');
        }
        
        function showSuccess(message) {
            console.log(message);
            createToast(message, 'success');
        }
        
        function showInfo(message) {
            console.info(message);
            createToast(message, 'info');
        }
        
        function createToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            switch (type) {
                case 'error':
                    toast.style.backgroundColor = '#FF3B30';
                    // Haptic feedback for errors on mobile
                    if (navigator.vibrate && transcribeState.browserInfo.isMobile) {
                        navigator.vibrate([300, 100, 300]);
                    }
                    break;
                case 'warning':
                    toast.style.backgroundColor = '#FF9500';
                    if (navigator.vibrate && transcribeState.browserInfo.isMobile) {
                        navigator.vibrate(200);
                    }
                    break;
                case 'success':
                    toast.style.backgroundColor = '#34C759';
                    if (navigator.vibrate && transcribeState.browserInfo.isMobile) {
                        navigator.vibrate(100);
                    }
                    break;
                case 'info':
                    toast.style.backgroundColor = '#007AFF';
                    break;
                default:
                    toast.style.backgroundColor = '#007AFF';
            }
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after delay (longer for errors)
            const displayTime = type === 'error' ? 8000 : (type === 'warning' ? 5000 : 3000);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, displayTime);
            
            // Allow manual dismissal by clicking
            toast.addEventListener('click', () => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
            
            // Add close button for errors
            if (type === 'error') {
                const closeBtn = document.createElement('span');
                closeBtn.innerHTML = ' ✕';
                closeBtn.style.cssText = 'margin-left: 10px; cursor: pointer; font-weight: bold;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    toast.click();
                };
                toast.appendChild(closeBtn);
            }
        }
        
        // Integration API for embedding
        window.TranscribeWidget = {
            // Public methods for parent page
            start: () => !transcribeState.isRecording && startRecording(),
            stop: () => transcribeState.isRecording && stopRecording(),
            getTranscript: () => getTranscript(),
            getWordCount: () => transcribeState.wordCount,
            getDuration: () => transcribeState.duration,
            isRecording: () => transcribeState.isRecording,
            setLanguage: (lang) => updateLanguage(lang),
            clear: () => clearTranscript(),
            
            // Punctuation-specific methods
            togglePunctuation: () => togglePunctuationMode(),
            setPunctuationSensitivity: (level) => updatePunctuationSensitivity(level),
            getPunctuationSettings: () => ({
                enabled: transcribeState.settings.autoPunctuation,
                sensitivity: transcribeState.settings.punctuationSensitivity,
                highlighting: transcribeState.settings.highlightAutoPunctuation,
                showConfidence: transcribeState.settings.showPunctuationConfidence
            }),
            
            // Event listeners
            on: (event, callback) => widget.on(event, callback),
            
            // Widget info
            version: '1.0.0'
        };


        








        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle page visibility for battery optimization
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && transcribeState.isRecording) {
                // Continue recording in background
                widget.emit('background', { isRecording: true });
            }
        });
        
        // Handle online/offline status
        window.addEventListener('online', () => {
            showSuccess('Connection restored');
        });
        
        window.addEventListener('offline', () => {
            showWarning('Offline - recording continues locally');
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', (event) => {
            if (transcribeState.isRecording) {
                event.preventDefault();
                event.returnValue = 'Recording in progress. Are you sure you want to leave?';
                return event.returnValue;
            }
        });





        // Cleanup action items management function (not used in this context)
        // This function was causing syntax errors and is not needed for the core transcription widget
























        

        

        

        

        

        

        

        

        

        

        

        
        // Success handling is now centralized in createToast function
        

        

        

        

        

        

        

        

        

        
        // Improved browser compatibility check
        function checkMobileBrowserSupport() {
            const supportStatus = checkBrowserSupport();
            
            // Show mobile-specific warnings
            if (!supportStatus.getUserMedia && window.innerWidth <= 767) {
                showError('This mobile browser doesn\'t support audio recording. Please try Chrome or Safari.');
            }
            
            // Check if it's a mobile device
            const isMobile = window.innerWidth <= 767 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Add mobile class to body
                document.body.classList.add('mobile-device');
                
                // Preload microphone permission status
                navigator.permissions.query({ name: 'microphone' }).then(result => {
                    appState.microphonePermission = result.state;
                    if (result.state === 'denied') {
                        showError('Microphone access is currently blocked. Enable it in your browser settings to use recording features.');
                    }
                }).catch(() => {
                    // Permissions API not supported, will handle on first recording attempt
                });
            }
            
            return { ...supportStatus, isMobile };
        }
        

        

        

        
        // Handle online/offline status
        window.addEventListener('online', () => {
            showSuccess('Connection restored');
        });
        
        window.addEventListener('offline', () => {
            showError('Connection lost - recordings will continue offline');
        });
    </script>
</body>
</html>